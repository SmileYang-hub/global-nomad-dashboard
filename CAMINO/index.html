<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å“†å•¦Aå¤¢æœè–ä¹‹è·¯ (Camino GO!)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dora: {
                            blue: '#009BDE',
                            red: '#E4002B',
                        },
                        bell: {
                            yellow: '#F1C40F'
                        }
                    },
                    fontFamily: {
                        sans: ['Iansui', 'sans-serif'],
                    },
                    borderRadius: {
                        '4xl': '2rem',
                        '5xl': '2.5rem',
                    }
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body {
            background-color: #F0F9FF; /* æ¥µæ·ºè—èƒŒæ™¯ */
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px; /* é¿é–‹åº•éƒ¨å°èˆª */
        }

        /* ç»ç’ƒæ“¬æ…‹å¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* éš±è— Scrollbar ä½†ä¿æŒæ»‘å‹• */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ä¸‹æ‹‰é¸å–®æ¨£å¼å„ªåŒ– */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23009BDE' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        
        /* å‹•ç•«æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-dora-blue p-4 rounded-b-[2rem] shadow-md flex items-center justify-between gap-3 sticky top-0 z-50 transition-all">
        <div class="flex items-center gap-3 flex-1">
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shrink-0 shadow-sm">
                <i data-lucide="footprints" class="text-dora-blue w-6 h-6"></i>
            </div>
            <div class="flex flex-col">
                <h1 class="text-2xl font-black text-white leading-none tracking-tight">Camino GO!</h1>
                <p class="text-white/90 text-sm font-bold mt-0.5">Jianiï¼Œæˆ‘å€‘å‡ºç™¼å§ï¼</p>
            </div>
        </div>

        <div class="relative w-14 h-14 rounded-full bg-dora-blue border-4 border-white shadow-lg flex items-center justify-center shrink-0">
            <i data-lucide="bell" class="text-bell-yellow fill-bell-yellow w-7 h-7"></i>
            <div class="absolute top-3 right-3 w-3 h-3 bg-dora-red rounded-full border-2 border-white"></div>
        </div>
    </header>

    <main id="app-container" class="p-5 max-w-lg mx-auto">
        <div class="text-center py-20 text-dora-blue">
            <p class="text-xl font-bold animate-pulse">æ­£åœ¨æ‹¿å‡ºä»»æ„é–€...</p>
            <p class="text-sm mt-2 opacity-70">è®€å– CSV è³‡æ–™ä¸­</p>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 w-full h-[80px] bg-white shadow-[0_-5px_15px_rgba(0,0,0,0.05)] rounded-t-[2rem] z-50 flex items-center justify-around px-2 border-t border-blue-50">
        <button onclick="switchTab('route')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-20 transition-all" id="btn-route">
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                <i data-lucide="map" class="w-6 h-6 text-gray-400 group-[.active]:text-dora-blue group-[.active]:fill-blue-100 transition-colors"></i>
            </div>
            <span class="text-xs font-bold text-gray-400 group-[.active]:text-dora-blue">è¡Œç¨‹</span>
        </button>
        
        <button onclick="switchTab('toolkit')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-20 transition-all" id="btn-toolkit">
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                <i data-lucide="briefcase" class="w-6 h-6 text-gray-400 group-[.active]:text-dora-blue group-[.active]:fill-blue-100 transition-colors"></i>
            </div>
            <span class="text-xs font-bold text-gray-400 group-[.active]:text-dora-blue">ç™¾å¯¶è¢‹</span>
        </button>

        <button onclick="switchTab('expense')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-20 transition-all" id="btn-expense">
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                <i data-lucide="wallet" class="w-6 h-6 text-gray-400 group-[.active]:text-dora-blue group-[.active]:fill-blue-100 transition-colors"></i>
            </div>
            <span class="text-xs font-bold text-gray-400 group-[.active]:text-dora-blue">è¨˜å¸³</span>
        </button>
    </nav>

    <script>
        // ==========================================
        // 0. å…¨åŸŸè®Šæ•¸èˆ‡ç‹€æ…‹
        // ==========================================
        const STATE = {
            currentTab: 'route',
            currentStageId: '1',
            stages: [],
            itinerary: [],
            toolkit: [],
            expenses: JSON.parse(localStorage.getItem('camino_exp_v2')) || []
        };

        const REFS = {
            container: document.getElementById('app-container'),
            navBtns: document.querySelectorAll('.nav-btn')
        };

        // ==========================================
        // 1. è³‡æ–™è®€å–å¼•æ“ (Data Engine)
        // ==========================================
        async function initApp() {
            try {
                // å®šç¾© Fetch èˆ‡ Clean å‡½å¼
                const fetchData = async (file) => {
                    const response = await fetch(file);
                    let text = await response.text();
                    // CRITICAL: æ¸…æ´— Excel è½‰ CSV å¯èƒ½ç”¢ç”Ÿçš„å¤šé¤˜å¼•è™Ÿ
                    text = text.replace(/^"|"$/gm, '').trim(); 
                    return new Promise((resolve) => {
                        Papa.parse(text, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => resolve(results.data)
                        });
                    });
                };

                // Promise.all åŒæ™‚è®€å–
                const [stages, itinerary, toolkit] = await Promise.all([
                    fetchData('camino_stages.csv'),
                    fetchData('camino_itinerary.csv'),
                    fetchData('camino_toolkit.csv')
                ]);

                STATE.stages = stages;
                STATE.itinerary = itinerary;
                STATE.toolkit = toolkit;

                // åˆå§‹åŒ–å®Œç•¢ï¼Œæ¸²æŸ“é è¨­é é¢
                renderRouteTab();
                updateNavState();

            } catch (error) {
                console.error("Data Engine Error:", error);
                REFS.container.innerHTML = `
                    <div class="text-center p-10">
                        <p class="text-dora-red font-bold text-xl">å¤§é›„ï¼Œè³‡æ–™è®€å–å¤±æ•—äº†ï¼</p>
                        <p class="text-gray-500 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // ==========================================
        // 2. é é¢åˆ‡æ›é‚è¼¯
        // ==========================================
        function switchTab(tabName) {
            STATE.currentTab = tabName;
            updateNavState();
            
            // æ²å‹•å›é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (tabName === 'route') renderRouteTab();
            else if (tabName === 'toolkit') renderToolkitTab();
            else if (tabName === 'expense') renderExpenseTab();
        }

        function updateNavState() {
            REFS.navBtns.forEach(btn => {
                if (btn.id === `btn-${STATE.currentTab}`) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            lucide.createIcons();
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // 3. ç¬¬ä¸€åˆ†é ï¼šè¡Œç¨‹ (Route)
        // ==========================================
        function renderRouteTab() {
            // A. æ‰¾å‡ºç›®å‰ Stage çš„è³‡æ–™
            const currentStageData = STATE.stages.find(s => s.ID == STATE.currentStageId) || STATE.stages[0];
            
            // B. ç¯©é¸åŸå¸‚å¡ç‰‡ (Filter Loop)
            const currentCities = STATE.itinerary.filter(c => c.StageID == STATE.currentStageId);

            let html = `
                <div class="flex flex-col gap-6 fade-in pb-10">
                    
                    <div class="glass-card rounded-[2rem] p-2 shadow-sm">
                        <select id="stageSelector" onchange="handleStageChange(this.value)" 
                            class="w-full bg-blue-50 text-blue-900 font-bold p-4 rounded-[1.5rem] outline-none text-lg">
                            ${STATE.stages.map(s => 
                                `<option value="${s.ID}" ${s.ID == STATE.currentStageId ? 'selected' : ''}>${s.Title}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="flex flex-col gap-4">
                        <div class="w-full h-64 relative rounded-[2rem] overflow-hidden shadow-lg bg-gray-200">
                            <img src="img/s${STATE.currentStageId}_hero.jpg" 
                                 onerror="this.src='https://placehold.co/600x400/009BDE/FFFFFF?text=Camino+Stage+${STATE.currentStageId}'"
                                 class="w-full h-full object-cover" alt="Stage Hero">
                            
                            <div class="absolute bottom-6 left-6 max-w-[70%] z-10">
                                <h2 class="text-white text-3xl font-black leading-snug break-words drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)]">
                                    ${currentStageData.Title}
                                </h2>
                            </div>
                        </div>

                        <div class="glass-card p-5 rounded-2xl">
                            <p class="text-dora-blue font-bold leading-relaxed">
                                ğŸ“ ${currentStageData.Description}
                            </p>
                        </div>
                    </div>

                    <div class="border-b-2 border-dashed border-blue-200 my-2"></div>

                    <div class="flex flex-col gap-8">
                        ${currentCities.map(city => renderCityCard(city)).join('')}
                    </div>
                </div>
            `;

            REFS.container.innerHTML = html;
            lucide.createIcons();
        }

        function handleStageChange(newId) {
            STATE.currentStageId = newId;
            renderRouteTab();
        }

        function renderCityCard(city) {
            // Tips æ¢ä»¶æ¸²æŸ“
            const tipsHtml = [
                { val: city.Tip1, bg: 'bg-blue-50', text: 'text-blue-700' },
                { val: city.Tip2, bg: 'bg-pink-50', text: 'text-pink-700' },
                { val: city.Tip3, bg: 'bg-yellow-50', text: 'text-yellow-700' }
            ].filter(t => t.val).map(t => `
                <div class="${t.bg} ${t.text} px-3 py-2 rounded-xl text-sm font-bold shadow-sm">
                    ${t.val}
                </div>
            `).join('');

            return `
                <div class="glass-card rounded-[2.5rem] p-6 relative flex flex-col gap-4 shadow-md transition-transform active:scale-[0.99]">
                    <div onclick="scrollToTop()" class="absolute top-0 right-0 bg-dora-blue text-white px-5 py-3 rounded-bl-[2rem] rounded-tr-[2.5rem] font-black text-xl shadow-md cursor-pointer active:bg-blue-600">
                        ${city.CityNo}
                    </div>

                    <div class="mt-2 pr-16">
                        <h3 class="text-3xl font-black text-slate-900 break-words hyphens-auto leading-tight mb-1">
                            ${city.CityEN}
                        </h3>
                        <h4 class="text-lg font-bold text-gray-400">
                            ${city.CityCN}
                        </h4>
                    </div>

                    <p class="text-gray-600 leading-relaxed font-medium">
                        ${city.Description}
                    </p>

                    ${tipsHtml ? `<div class="flex flex-wrap gap-2 mt-1">${tipsHtml}</div>` : ''}

                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(city.CityEN)}" 
                       target="_blank"
                       class="mt-2 bg-dora-red text-white py-4 rounded-full flex items-center justify-center gap-2 font-black shadow-lg shadow-red-200 active:scale-95 transition-transform no-underline">
                        <i data-lucide="map-pin" class="w-5 h-5"></i>
                        <span>ğŸ—ºï¸ é–‹å•Ÿä»»æ„é–€</span>
                    </a>
                </div>
            `;
        }


        // ==========================================
        // 4. ç¬¬äºŒåˆ†é ï¼šç™¾å¯¶è¢‹ (Toolkit)
        // ==========================================
        function renderToolkitTab() {
            const categories = [
                { key: 'phrase', title: 'å¸¸ç”¨è¥¿èª', icon: 'languages', color: 'blue' },
                { key: 'sign', title: 'è·¯æ¨™è­˜åˆ¥', icon: 'signpost', color: 'yellow' },
                { key: 'gear', title: 'è£å‚™æª¢æŸ¥', icon: 'backpack', color: 'green' },
                { key: 'tip', title: 'å¯¦ç”¨å»ºè­°', icon: 'lightbulb', color: 'red' }
            ];

            const colorMap = {
                blue: { bg: 'bg-blue-100', text: 'text-blue-600', border: 'border-blue-500' },
                yellow: { bg: 'bg-yellow-100', text: 'text-yellow-600', border: 'border-yellow-500' },
                green: { bg: 'bg-green-100', text: 'text-green-600', border: 'border-green-500' },
                red: { bg: 'bg-red-100', text: 'text-red-600', border: 'border-red-500' }
            };

            let navGridHtml = `
                <div class="grid grid-cols-4 gap-2 mb-8">
                    ${categories.map(cat => {
                        const style = colorMap[cat.color];
                        return `
                        <button onclick="document.getElementById('cat-${cat.key}').scrollIntoView({behavior: 'smooth', block: 'start'})"
                            class="${style.bg} ${style.text} flex flex-col items-center justify-center p-3 rounded-2xl gap-1 active:scale-90 transition-transform shadow-sm h-20">
                            <i data-lucide="${cat.icon}" class="w-6 h-6"></i>
                            <span class="text-xs font-bold">${cat.title}</span>
                        </button>`;
                    }).join('')}
                </div>
            `;

            let contentHtml = categories.map(cat => {
                const items = STATE.toolkit.filter(item => item.Category === cat.key);
                if (items.length === 0) return '';

                return `
                    <div id="cat-${cat.key}" class="mb-8 scroll-mt-24">
                        <h3 onclick="scrollToTop()" class="text-xl font-black text-slate-800 mb-4 pl-4 border-l-4 border-dora-blue cursor-pointer">
                            ${cat.title}
                        </h3>
                        <div class="flex flex-col gap-3">
                            ${items.map(item => renderToolkitItem(item, cat.key)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            REFS.container.innerHTML = `<div class="fade-in">${navGridHtml}${contentHtml}</div>`;
            lucide.createIcons();
        }

        function renderToolkitItem(item, categoryKey) {
            // å³å´åŠŸèƒ½å€é‚è¼¯
            let actionHtml = '';
            if (categoryKey === 'phrase') {
                actionHtml = `
                    <button onclick="speakText('${item.Title}')" class="shrink-0 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 active:bg-blue-200 active:scale-90 transition-all">
                        <i data-lucide="volume-2" class="w-6 h-6"></i>
                    </button>
                `;
            } else if (categoryKey === 'gear') {
                actionHtml = `
                    <div class="shrink-0">
                        <input type="checkbox" class="w-8 h-8 rounded-lg text-green-500 focus:ring-green-500 border-gray-300">
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-[1.5rem] p-5 flex items-center gap-4 shadow-sm border border-blue-50/50">
                    <div class="text-3xl shrink-0">${item.ItemIcon}</div>
                    
                    <div class="flex-1 min-w-0 flex flex-col gap-1">
                        <p class="text-lg font-black text-slate-800 break-words whitespace-normal leading-tight">
                            ${item.Title}
                        </p>
                        <p class="text-sm font-bold text-gray-400 break-words whitespace-normal">
                            ${item.Subtitle}
                        </p>
                    </div>

                    ${actionHtml}
                </div>
            `;
        }

        function speakText(text) {
            // ç°¡å–® TTS
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES'; // å‡è¨­æ˜¯è¥¿èª
            window.speechSynthesis.speak(utterance);
        }


        // ==========================================
        // 5. ç¬¬ä¸‰åˆ†é ï¼šè¨˜å¸³ (Expense)
        // ==========================================
        function renderExpenseTab() {
    const totalEuro = STATE.expenses.reduce((sum, item) => sum + parseFloat(item.amount), 0);
    const exchangeRate = 35.5; // åœ¨é€™è£¡èª¿æ•´åŒ¯ç‡
    const totalTWD = Math.round(totalEuro * exchangeRate);

    const categories = [
        { name: 'ä½å®¿', icon: 'bed', color: 'bg-blue-100 text-blue-600' },
        { name: 'é¤é£²', icon: 'utensils', color: 'bg-orange-100 text-orange-600' },
        { name: 'äº¤é€š', icon: 'bus', color: 'bg-green-100 text-green-600' },
        { name: 'è£å‚™', icon: 'backpack', color: 'bg-purple-100 text-purple-600' },
        { name: 'é–€ç¥¨', icon: 'ticket', color: 'bg-pink-100 text-pink-600' },
        { name: 'å…¶ä»–', icon: 'more-horizontal', color: 'bg-gray-100 text-gray-600' }
    ];

    let html = `
        <div class="flex flex-col gap-6 fade-in pb-10">
            <div class="bg-gradient-to-br from-emerald-400 to-teal-600 rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden">
                <p class="text-emerald-100 font-bold mb-1">ç¸½æ”¯å‡º (Total)</p>
                <div class="flex flex-col gap-1">
                    <span class="text-4xl font-black">â‚¬${totalEuro.toFixed(2)}</span>
                    <span class="text-xl font-bold opacity-90">â‰ˆ NT$${totalTWD.toLocaleString()}</span>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3">
                ${categories.map(c => `
                    <button id="btn-cat-${c.name}" onclick="prefillCategory('${c.name}')" 
                        class="${c.color} p-3 rounded-2xl flex flex-col items-center gap-1 shadow-sm active:scale-95 transition-transform">
                        <i data-lucide="${c.icon}" class="w-6 h-6"></i>
                        <span class="text-xs font-bold text-black">${c.name}</span>
                    </button>
                `).join('')}
            </div>

           

<div class="glass-card p-4 rounded-[2rem] flex flex-col gap-3 shadow-inner bg-white/50">
                
                <div class="flex w-full gap-2">
                    <div style="width: 48%;">
                        <label class=" text-l font-bold text-dora-blue ml-2 mb-1 block"> ğŸ“…æ—¥æœŸ</label>
                        <input type="date" id="exp-date" 
                            class="w-full bg-gray-50 rounded-xl px-2 py-3 text-[11px] font-bold outline-none border-2 border-transparent focus:border-dora-blue appearance-none">
                    </div>
                    <div style="width: 52%;">
                         <label class=" text-l  font-bold text-dora-blue ml-2 mb-1 block"> ğŸ“ é …ç›®</label>
                        <input type="text" id="exp-name" placeholder="åç¨±" 
                            class="w-full bg-gray-50 rounded-xl px-3 py-3 text-sm font-bold outline-none border-2 border-transparent focus:border-dora-blue" 
                            onkeypress="handleEnter(event, 'exp-amount')">
                    </div>
                </div>

                <div class="flex w-full gap-2">
                    <div style="width: 48%;">
                        <label class="text-l font-bold text-dora-blue ml-2 mb-1 block">ğŸ’° é‡‘é¡ (â‚¬)</label>
                        <input type="number" id="exp-amount" inputmode="decimal" step="0.01" placeholder="0.00" 
                            class="w-full bg-gray-50 rounded-xl px-3 py-3 font-black outline-none border-2 border-transparent focus:border-dora-blue text-lg" 
                            onkeypress="handleEnter(event, 'submit')">
                    </div>
                    <div style="width: 52%;" class="flex flex-col">
                        
                        <button onclick="addExpense()" class="w-full h-[52px] bg-dora-blue text-white rounded-xl flex items-center justify-center gap-1 shadow-md active:scale-95 transition-transform font-black">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span class="text-sm">æ–°å¢</span>
                        </button>
                    </div>
                </div>
            </div>
            <div id="expense-list" class="flex flex-col gap-3">
                ${STATE.expenses.length === 0 ? '<p class="text-center text-gray-400 py-4">ç¹¼çºŒä¿æŒé›¶æ”¯å‡º</p>' : 
                    STATE.expenses.slice().reverse().map((item, index) => {
                        const realIndex = STATE.expenses.length - 1 - index;
                        return `
                        <div class="bg-white p-4 rounded-2xl shadow-sm flex items-center justify-between border border-gray-100">
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-400 font-bold">${item.date}</span>
                                <span class="font-black text-slate-800 text-lg">${item.name}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xl font-black text-dora-blue">â‚¬${item.amount}</span>
                                <button onclick="deleteExpense(${realIndex})" class="text-red-300">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>`;
                    }).join('')
                }
            </div>
        </div>
    `;

    REFS.container.innerHTML = html;
    document.getElementById('exp-date').valueAsDate = new Date();
    lucide.createIcons();
}
       function prefillCategory(catName) {
    const nameInput = document.getElementById('exp-name');
    if (!nameInput) return;

    nameInput.value = catName + " - ";
    
    // å¼·åˆ¶ Focus èˆ‡æ¸¸æ¨™å®šä½
    setTimeout(() => {
        nameInput.focus();
        const len = nameInput.value.length;
        nameInput.setSelectionRange(len, len);
    }, 50);
}        function handleEnter(e, nextTarget) {
    if (e.key === 'Enter') {
        if (nextTarget === 'submit') {
            addExpense(); // å„²å­˜å¾Œæœƒè‡ªå‹•å›åˆ°ã€Œé¤é£² - ã€ç‹€æ…‹
        } else {
            document.getElementById(nextTarget).focus();
        }
    }
}

function addExpense() {
    const date = document.getElementById('exp-date').value;
    const name = document.getElementById('exp-name').value;
    const amount = document.getElementById('exp-amount').value;

    if (!name || !amount) {
        alert('å“†å•¦Aå¤¢æé†’ï¼šé …ç›®å’Œé‡‘é¡éƒ½è¦å¡«å–”ï¼');
        return;
    }

    STATE.expenses.push({ date, name, amount });
    localStorage.setItem('camino_exp_v2', JSON.stringify(STATE.expenses));

    // 1. é‡æ–°æ¸²æŸ“
    renderExpenseTab();
    
    // 2. é‡å°æ‰‹æ©Ÿå„ªåŒ–çš„å™´å°„æ¸¸æ¨™ (250ms æ˜¯é»ƒé‡‘å»¶é²)
    setTimeout(() => {
        const nameInput = document.getElementById('exp-name');
        if (nameInput) {
            nameInput.value = "é¤é£² - ";
            nameInput.focus();
            
            // å°‡æ¸¸æ¨™ç§»åˆ°æœ€å¾Œé¢ï¼Œè®“ä½ ç›´æ¥è¼¸å…¥ç´°é …
            const len = nameInput.value.length;
            nameInput.setSelectionRange(len, len);
            
            // è®“æ‰‹æ©Ÿè‡ªå‹•æ²å‹•åˆ°è¼¸å…¥æ¡†ä¸­å¿ƒ
            nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 250); 
}
        function deleteExpense(index) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                STATE.expenses.splice(index, 1);
                localStorage.setItem('camino_exp_v2', JSON.stringify(STATE.expenses));
                renderExpenseTab();
            }
        }

       function exportCSV() {
    try {
        // 1. æº–å‚™å…§å®¹ (BOM + å…§å®¹)
        const csvContent = "\uFEFF" + "Date,Item,Amount(Euro)\n" 
            + STATE.expenses.map(e => `${e.date},${e.name},${e.amount}`).join("\n");
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const fileName = "camino_expenses.csv";

        // 2. é‡å°æ‰‹æ©Ÿç«¯ä¸‹è¼‰çš„å„ªåŒ–è™•ç†
        if (navigator.msSaveBlob) { 
            // é‡å°èˆŠç‰ˆ IE (é˜²ç¯„è¬ä¸€)
            navigator.msSaveBlob(blob, fileName);
        } else {
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.href = url;
            link.setAttribute("download", fileName);
            
            // é—œéµä¿®æ­£ï¼šæŸäº›æ‰‹æ©Ÿç€è¦½å™¨éœ€è¦ link å‡ºç¾åœ¨ç•«é¢ä¸Šæ‰èƒ½è§¸ç™¼
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            
            link.click();
            
            // å»¶é²ç§»é™¤ï¼Œç¢ºä¿ä¸‹è¼‰å‹•ä½œå·²äº¤çµ¦ç³»çµ±
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);
        }
    } catch (err) {
        alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹å˜—è©¦ä½¿ç”¨ Chrome æˆ– Safari ç€è¦½å™¨æ‰“é–‹ç¶²é ã€‚");
        console.error(err);
    }
}
        // ==========================================
        // åˆå§‹åŒ–
        // ==========================================
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>

