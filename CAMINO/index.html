<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å“†å•¦Aå¤¢æœè–ä¹‹è·¯ App (ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Nunito:wght@700;900&family=Noto+Sans+TC:wght@500;700;900&display=swap');
        :root { --dora-blue: #009BDE; --dora-red: #E4002B; }
        body { font-family: 'Nunito', 'Noto Sans TC', sans-serif; background-color: #f0f9ff; color: #1e3a8a; margin: 0; padding-bottom: 120px; }
        .dora-font { font-family: 'ZCOOL KuaiLe', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 2px solid white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .img-placeholder { background: #e2e8f0; height: 250px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 2.5rem; font-weight: bold; }
    </style>
</head>
<body>

    <header class="p-8 text-center bg-white rounded-b-[3rem] shadow-sm mb-6">
        <h1 class="text-4xl font-black text-blue-600 dora-font tracking-wider">æœè–ç™¾å¯¶è¢‹</h1>
        <p class="text-xl font-bold text-red-500 mt-2">å¤§é›„ï¼æ‰“èµ·ç²¾ç¥ï¼Œæˆ‘å€‘å‡ºç™¼å§ï¼</p>
    </header>

    <main class="px-6">
        <section id="section-route" class="tab-content active">
            <div class="mb-8">
                <p class="text-xl font-bold mb-3 ml-4 text-blue-400">ğŸ“ è«‹é¸æ“‡å†’éšªéšæ®µï¼š</p>
                <select id="stage-selector" onchange="renderStage(this.value)" class="w-full p-6 rounded-[2.5rem] border-4 border-blue-400 bg-white text-2xl font-black shadow-xl focus:outline-none appearance-none">
                    </select>
            </div>
            
            <div id="route-display" class="space-y-8">
                </div>
        </section>

        <section id="section-toolkit" class="tab-content">
            <div id="toolkit-top" class="grid grid-cols-2 gap-4 mb-8">
                <button onclick="scrollToId('packing-list')" class="p-6 rounded-[2.5rem] bg-yellow-400 text-blue-900 text-xl font-black shadow-lg">ğŸ’ è£å‚™</button>
                <button onclick="scrollToId('survival-phrases')" class="p-6 rounded-[2.5rem] bg-blue-400 text-white text-xl font-black shadow-lg">ğŸ—£ï¸ èªå¥</button>
            </div>
            <div class="space-y-12">
                <div id="packing-list" class="glass-card p-8 rounded-[2.5rem]">
                    <h2 class="text-2xl font-black mb-6">ğŸ’ å¿…å‚™é“å…·æ¸…å–®</h2>
                    <div id="checklist-items" class="space-y-4"></div>
                </div>
            </div>
        </section>

        <section id="section-expense" class="tab-content">
            <div class="glass-card p-8 rounded-[2.5rem] mb-6 shadow-xl text-center">
                <p class="text-xl font-bold opacity-60">ä»Šæ—¥å†’éšªèŠ±è²»</p>
                <h2 id="total-expense" class="text-5xl font-black text-blue-600 my-2">â‚¬ 0.00</h2>
                <p id="total-twd" class="text-lg font-bold text-red-500">â‰ˆ TWD 0</p>
            </div>
            <div id="expense-list" class="space-y-4"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t-4 border-blue-400 px-8 py-6 flex justify-between items-center z-[100]">
        <button onclick="switchTab('section-route')" class="flex flex-col items-center text-blue-600">
            <i data-lucide="map" class="w-8 h-8"></i><span class="text-xl font-black mt-1">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('section-toolkit')" class="flex flex-col items-center text-gray-400">
            <i data-lucide="briefcase" class="w-8 h-8"></i><span class="text-xl font-black mt-1">ç™¾å¯¶è¢‹</span>
        </button>
        <button onclick="switchTab('section-expense')" class="flex flex-col items-center text-gray-400">
            <i data-lucide="wallet" class="w-8 h-8"></i><span class="text-xl font-black mt-1">è¨˜å¸³</span>
        </button>
    </nav>

    <script>
        const EXCHANGE_RATE_TWD = 35.5; 
        let stagesData = [];
        let itineraryData = [];

        async function init() {
            try {
                // 1. è®€å–ä¸¦å¼·åŠ›æ¸…ç† CSV
                const [sRes, iRes] = await Promise.all([
                    fetch('camino_stages.csv').then(r => r.text()),
                    fetch('camino_itinerary.csv').then(r => r.text())
                ]);

                // æ¸…ç†é‚è¼¯ï¼šå»é¦–å°¾å¼•è™Ÿã€å»ç©ºç™½
                const cleanS = sRes.replace(/^"|"$/gm, '').trim();
                const cleanI = iRes.replace(/^"|"$/gm, '').trim();

                stagesData = Papa.parse(cleanS, { header: true, skipEmptyLines: true }).data;
                itineraryData = Papa.parse(cleanI, { header: true, skipEmptyLines: true }).data;

                console.log("è¼‰å…¥éšæ®µæ•¸:", stagesData.length);
                console.log("è¼‰å…¥è¡Œç¨‹ç¸½æ•¸:", itineraryData.length);

                populateSelector();
                if (stagesData.length > 0) renderStage(stagesData[0].ID);
                
                lucide.createIcons();
            } catch (e) {
                console.error("è³‡æ–™è®€å–å¤±æ•—ï¼Œå¿«æª¢æŸ¥æª”æ¡ˆåç¨±ï¼", e);
            }
        }

        function populateSelector() {
            const selector = document.getElementById('stage-selector');
            selector.innerHTML = stagesData.map(s => `<option value="${s.ID.trim()}">${s.Title}</option>`).join('');
        }

        function renderStage(selectedId) {
            const stage = stagesData.find(s => s.ID.trim() === selectedId.trim());
            // æ ¸å¿ƒè¿´åœˆé‚è¼¯ï¼šéæ¿¾å‡ºå±¬æ–¼è©²éšæ®µçš„æ‰€æœ‰åŸå¸‚
            const cities = itineraryData.filter(i => i.éšæ®µ.trim() === selectedId.trim());

            console.log(`æ­£åœ¨æ¸²æŸ“éšæ®µ ${selectedId}, æ‰¾åˆ°åŸå¸‚æ•¸é‡:`, cities.length);

            let html = `
                <div class="mb-10 text-center">
                    <h2 class="text-3xl font-black text-blue-900 mb-4 dora-font">${stage.Title}</h2>
                    <p class="text-xl font-bold text-gray-600 px-4">${stage.Description}</p>
                    <div class="mt-6 px-2">
                        <img src="img/s${selectedId}_hero.jpg" class="w-full rounded-[2.5rem] shadow-2xl border-8 border-white" 
                             onerror="this.style.display='none';this.insertAdjacentHTML('afterend','<div class=img-placeholder><span class=text-4xl>ğŸ“·</span><p class=mt-2>Stage ${selectedId} çš„å†’éšªç…§ç‰‡</p></div>');">
                    </div>
                </div>
            `;

            // åŸå¸‚è¿´åœˆæ¸²æŸ“
            if (cities.length === 0) {
                html += `<p class="text-center text-xl font-bold text-red-400">å’¦ï¼Ÿé€™å€‹éšæ®µç›®å‰æ²’æœ‰åŸå¸‚è³‡æ–™å–”ï¼</p>`;
            } else {
                cities.forEach(city => {
                    html += `
                        <div class="glass-card p-8 rounded-[2.5rem] shadow-lg border-b-[12px] border-blue-200">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-2xl font-black text-blue-900 leading-tight">${city.åŸå¸‚ä¸­æ–‡}</h3>
                                    <p class="text-lg font-bold text-gray-400 uppercase tracking-tighter">${city.åŸå¸‚è‹±æ–‡}</p>
                                </div>
                                <span class="bg-blue-500 text-white w-12 h-12 flex items-center justify-center rounded-full font-black text-xl shadow-md">${city.åŸå¸‚ç·¨è™Ÿ}</span>
                            </div>
                            
                            <p class="text-xl font-bold text-gray-700 mb-8 leading-relaxed">${city.æè¿°}</p>

                            <div class="grid grid-cols-3 gap-3 mb-8">
                                <div class="p-3 bg-yellow-50 rounded-[1.5rem] border-2 border-yellow-200 text-center">
                                    <span class="text-2xl block mb-1">ğŸª„</span>
                                    <span class="text-base font-bold text-yellow-700">${city.æç¤º1 || 'åŠ æ²¹'}</span>
                                </div>
                                <div class="p-3 bg-red-50 rounded-[1.5rem] border-2 border-red-200 text-center">
                                    <span class="text-2xl block mb-1">ğŸšª</span>
                                    <span class="text-base font-bold text-red-700">${city.æç¤º2 || 'è¡é˜¿'}</span>
                                </div>
                                <div class="p-3 bg-blue-50 rounded-[1.5rem] border-2 border-blue-200 text-center">
                                    <span class="text-2xl block mb-1">ğŸ</span>
                                    <span class="text-base font-bold text-blue-700">${city.æç¤º3 || 'å°å¿ƒ'}</span>
                                </div>
                            </div>

                            <a href="https://www.google.com/maps/search/${encodeURIComponent(city.åŸå¸‚è‹±æ–‡)}" target="_blank" 
                               class="block w-full py-5 bg-red-500 text-white text-center rounded-[2.5rem] text-2xl font-black shadow-[0_6px_0_#b91c1c] active:shadow-none active:translate-y-1 transition-all">
                                ğŸ—ºï¸ é–‹å•Ÿéš¨æ„é–€å°èˆª
                            </a>
                        </div>
                    `;
                });
            }

            document.getElementById('route-display').innerHTML = html;
            // æ¯æ¬¡åˆ‡æ›éšæ®µå¾Œï¼Œè‡ªå‹•æ»¾å›é ‚éƒ¨ï¼Œè®“å¤§é›„çœ‹æœ€æ–°è³‡è¨Š
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('nav button').forEach(btn => btn.classList.replace('text-blue-600', 'text-gray-400'));
            event.currentTarget.classList.replace('text-gray-400', 'text-blue-600');
        }

        window.onload = init;
    </script>
</body>
</html>